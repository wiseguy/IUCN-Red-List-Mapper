<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>IUCN Red List Mapper</title>
        <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/2.2/js/dojo/dijit/themes/tundra/tundra.css">
        <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/2.2/js/esri/dijit/css/Popup.css">
        <link rel="stylesheet" type="text/css" href="styles/styles.css">
        <script type="text/javascript">
            var djConfig = {
                parseOnLoad: true
            };
        </script>
        <script type="text/javascript" src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=2.2">
        </script>
        <script src="js/constants.js" type="text/javascript">
        </script>
        <script src="js/tempo.js" type="text/javascript">
        </script>
        <script type="text/javascript">
            dojo.require("dijit.layout.BorderContainer");
            dojo.require("dijit.layout.ContentPane");
            dojo.require("esri.toolbars.navigation");
            dojo.require("dijit.form.Button");
            dojo.require("dijit.Toolbar");
            dojo.require("dijit.dijit");
            dojo.require("dijit.form.Button");
            dojo.require("esri.dijit.BasemapGallery");
            dojo.require("esri.dijit.Scalebar");
            dojo.require("dojo.window");
            dojo.require("esri.map");
            dojo.require("dijit.Tooltip");
            var map, extentMap, renderer, navToolbar, resizeTimer;
            var layerDefinitions = []; //used to filter the results for an individual species
            dojo.addOnLoad(onLoad);
            
            function onLoad(){
                ID_NO = getSpeciesID(); //get the species ID from the query string
                getExtent(ID_NO); //get the extent of the current species
                getSpeciesInfo(ID_NO); //get the species info
                map = new esri.Map("map", {
                    wrapAround180: true
                });
                extentMap = new esri.Map("extentMap", {
                    slider: false,
                    nav: false
                });
                //BASEMAP FOR THE OVERVIEW MAP
                var basemap = new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer");
                extentMap.addLayer(basemap);
                
                //EVENT LISTENERS FOR THE MAPS
                dojo.connect(extentMap, "onLoad", loadExtentMap); //disable the map navigation controls for the extent map
                dojo.connect(map, "onLoad", createScaleBar);
                dojo.connect(map, "onZoomStart", showLoading);
                dojo.connect(map, "onPanStart", showLoading);
                dojo.connect(map, "onExtentChange", extentChanged);
                
                //ADD THE DYNAMIC LAYERS TO THE MAP
                var basemap = new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer");
                map.addLayer(basemap);
                var imageParameters = new esri.layers.ImageParameters(); //image parameters for the layer
                imageParameters.layerIds = [0]; //layer filter for species range data
                imageParameters.layerOption = esri.layers.ImageParameters.LAYER_OPTION_SHOW;
                rdbLayer = new esri.layers.ArcGISDynamicMapServiceLayer("http://79.125.16.106/ArcGIS/rest/services/IUCN_Secure/Species_WebMercator/MapServer?token=" + token, {
                    "imageParameters": imageParameters,
                    opacity: 0.7
                });
                layerDefinitions[0] = "ID_NO='" + ID_NO + "'"; //set the initial definition expression
                rdbLayer.setLayerDefinitions(layerDefinitions); //apply the definition expression
                map.addLayer(rdbLayer);
                
                //ADD THE TOOLBAR
                navToolbar = new esri.toolbars.Navigation(map);
                dojo.connect(navToolbar, "onExtentHistoryChange", extentHistoryChangeHandler);
                
                //CREATE THE BASEMAP GALLERY
                var basemapGallery = new esri.dijit.BasemapGallery({
                    map: map,
                    bingMapsKey: "ApEtXt6OQmIxxBtaii01DEEG23Fx8OjcYrVFzWogoW96NcsjHsI6U8XjzdeG73RP"
                }, "basemapGallery");
                basemapGallery.startup();
                
            }
            
            function createScaleBar(){
                var scalebar = new esri.dijit.Scalebar({
                    map: map
                });
                dojo.connect(dijit.byId('map'), 'resize', function(){ //resize the map if the div is resized
                    clearTimeout(resizeTimer);
                    console.log('resize');
                    resizeTimer = setTimeout(function(){
                        map.resize();
                        map.reposition();
                    }, 500);
                });
            }
            
            function showBasemapGallery(){
                var button = dojo.byId("basemapGalleryButton");
                var coords = dojo.coords(button);
                var div = dojo.byId("basemapGalleryDiv");
                var windowBox = dojo.window.getBox();
                var divHeightStr = div.style.height;
                var divHeight = divHeightStr.substr(0, divHeightStr.length - 2);
                div.style.right = (windowBox.w - coords.x) + "px";
                div.style.top = Math.round((windowBox.h - divHeight) / 2) + "px";
                div.style.visibility = "visible";
            }
            
            function hideBasemapGallery(){
                div = dojo.byId("basemapGalleryDiv");
                div.style.visibility = "hidden";
            }
            
            function extentHistoryChangeHandler(){
                dijit.byId("zoomprev").disabled = navToolbar.isFirstExtent();
                dijit.byId("zoomnext").disabled = navToolbar.isLastExtent();
            }
            
            //GETS THE SPECIES ID FROM THE QUERYSTRING
            function getSpeciesID(){
                var queryParams = dojo.queryToObject(window.location.search.slice(1)); //get the query parameters
                var ID_NO = parseInt(queryParams["ID_NO"]); //get the ID_NO for the species
                return ID_NO;
            }
            
            //SHOWS THE LOADING IMAGE WHEN THE RDB LAYER IS LOADING
            function showLoading(){
                div = dojo.byId("loadingDiv");
                div.style.visibility = "visible";
                map.disableMapNavigation();
            }
            
            //HIDES THE LOADING IMAGE WHEN THE RDB LAYER IS LOADING
            function hideLoading(){
                div = dojo.byId("loadingDiv");
                div.style.visibility = "hidden";
                map.enableMapNavigation();
            }
            
            //GETS THE EXTENT OF THE PASSED SPECIES USING A SOE
            function getExtent(spcID){
                esri.request({
                    url: "http://79.125.16.106/ArcGIS/rest/services/IUCN_Secure/Species_WebMercator/MapServer/exts/IUCNRedListSOE/GetSpeciesExtent",
                    callbackParamName: "callback",
                    content: {
                        f: "json",
                        ID_NO: spcID,
                        token: token
                    },
                    load: function(response){
                        var extent = new esri.geometry.Extent(response.extent);
                        extent.spatialReference = new esri.SpatialReference({
                            wkid: 102100
                        });
                        map.setExtent(extent, true);
                        dojo.connect(rdbLayer, "onUpdate", function(e){
                            dojo.byId("mainLoadingDiv").style.visibility = "hidden";
                            dojo.byId("mapDiv").style.visibility = "visible";
                            dojo.byId("panel").style.visibility = "visible";
                            hideLoading();
                        });
                    },
                    error: esriConfig.defaults.io.errorHandler
                });
            }
            
            //DISABLE THE INTERACTIVITY IN THE OVERVIEW MAP
            function loadExtentMap(){
                extentMap.disableKeyboardNavigation();
                extentMap.disableMapNavigation();
                extentMap.disablePan();
            }
            
            //CALLED WHEN THE MAP EXTENT CHANGES AND DRAWS THE POLYGON ON THE OVERVIEW MAP
            function extentChanged(extent){
                extentMap.graphics.clear();
                var polygon = new esri.geometry.Polygon(new esri.SpatialReference({
                    wkid: 102100
                }));
                polygon.addRing([[extent.xmin, extent.ymin], [extent.xmin, extent.ymax], [extent.xmax, extent.ymax], [extent.xmax, extent.ymin], [extent.xmin, extent.ymin]]); //create the polygon for the overview map
                var screenGeometry = esri.geometry.toScreenGeometry(extentMap.extent, extentMap.width, extentMap.height, polygon); //convert it to a screen geometry to see how big it will be
                var screenPolygon = screenGeometry.rings[0]; //get the first ring of the screen geometry
                var minX = screenPolygon[0][0]; //get the minimum x screen coordinate
                var maxX = screenPolygon[2][0]; //get the maximum x screen coordinate
                if ((maxX - minX) < 3) { //if the polygon is smaller than 3 pixels across then it will not be visible, so draw as a point symbol
                    var centroid = extent.getCenter(); //get the centroid of the extent
                    symbol = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_SQUARE, 3, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 1), new dojo.Color([255, 0, 0]), 1);
                    extentMap.graphics.add(new esri.Graphic(centroid, symbol)); //create a simple marker symbol at the centroid of the extent
                }
                else {
                    symbol = new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 1);
                    extentMap.graphics.add(new esri.Graphic(polygon, symbol));//create a polygon that is the size and shape of the main map
                }
            }
            
            //CALLED WHEN THE PAGE LOADS AND GETS THE SPECIES INFO
            function getSpeciesInfo(spcID){
                dojo.io.script.get({
                    url: "http://api.iucnredlist.org/common_names/" + spcID + ".js?callback=parseSpeciesData"
                });
            }
            
            //ASYNCHRONOUS CALLBACK FUNCTION WITH THE RESULTS FOR THE SPECIES INFO
            function parseSpeciesData(results){
                if (results.species.length > 0) {
                    var species = results.species[0]; //get the species data
                    dojo.byId("spClass").innerHTML = capitaliseFirstLetter(species['class']);
                    dojo.byId("spOrder").innerHTML = capitaliseFirstLetter(species['order']);
                    dojo.byId("spFamily").innerHTML = capitaliseFirstLetter(species['family']);
                    dojo.byId("spGenus").innerHTML = capitaliseFirstLetter(species['genus']);
                    dojo.byId("spAuthority").innerHTML = species['authority'];
                    dojo.byId("species").innerHTML = "<i>" + species['scientific_name'] + "</i>";
                    dojo.byId("statusImage").src = "images/RL_" + species['category'] + ".png";
                    setImageTitle(species['category']);
                    var synonymy = results.common_names;
                    dojo.doc.title = synonymy[0]['name']; //set the document title
                    var names = "";
                    for (var i = synonymy.length - 1; i >= 0; i--) {
                        names = names + synonymy[i]['name']
                    };
                    dojo.byId('synonyms').innerHTML = names;
                }
                else {
                    dojo.byId("title").innerHTML = "No species found";
                }
            }
            
            function capitaliseFirstLetter(word){
                return word.substr(0, 1).toUpperCase() + word.substr(1, word.length - 1).toLowerCase();
            }
            
            function setImageTitle(category){
                switch (category) {
                    case "NE":
                        statusImage.title = "Not Evaluated";
                        break;
                    case "DD":
                        statusImage.title = "Data Deficient";
                        break;
                    case "LC":
                        statusImage.title = "Least Concern";
                        break;
                    case "NT":
                        statusImage.title = "Near Threatened";
                        break;
                    case "VU":
                        statusImage.title = "Vulnerable";
                        break;
                    case "EN":
                        statusImage.title = "Endangered";
                        break;
                    case "CR":
                        statusImage.title = "Critically Endangered";
                        break;
                    case "EW":
                        statusImage.title = "Extinct in the Wild";
                        break;
                    case "EX":
                        statusImage.title = "Extinct";
                        break;
                    default:
                        statusImage.title = "No information";
                }
            }
            
            function togglePanel(){
                if (dojo.byId("panel").style.visibility == "hidden") {
                    dojo.byId("panel").style.visibility = "visible";
                } 
                else {
                    dojo.byId("panel").style.visibility = "hidden";
                }
            }
        </script>
    </head>
    <body class="tundra">
        <div id="mainLoadingDiv">
            <img src="images/loading.gif" alt="Loading image"/>
        </div>
        <div id="closePanel">
            <img src="images/close.png" alt="Close button" onclick="togglePanel()"/>
        </div>
        <div id="mapDiv" dojotype="dijit.layout.BorderContainer" design="headline" gutters="false">
            <div id="map" dojotype="dijit.layout.ContentPane" region="center">
                <div id="loadingDiv">
                    <img id="loadingImg" src="images/loading.gif" alt="Loading image"/>
                </div>
            </div>
            <div id="navToolbar" dojoType="dijit.Toolbar">
                <div dojoType="dijit.form.Button" id="zoomin" iconClass="zoominIcon" onClick="navToolbar.activate(esri.toolbars.Navigation.ZOOM_IN);">
                </div>
                <div dojoType="dijit.form.Button" id="zoomout" iconClass="zoomoutIcon" onClick="navToolbar.activate(esri.toolbars.Navigation.ZOOM_OUT);">
                </div>
                <div dojoType="dijit.form.Button" id="zoomfullext" iconClass="zoomfullextIcon" onClick="navToolbar.zoomToFullExtent();">
                </div>
                <div dojoType="dijit.form.Button" id="zoomprev" iconClass="zoomprevIcon" onClick="navToolbar.zoomToPrevExtent();">
                </div>
                <div dojoType="dijit.form.Button" id="zoomnext" iconClass="zoomnextIcon" onClick="navToolbar.zoomToNextExtent();">
                </div>
                <div dojoType="dijit.form.Button" id="pan" iconClass="panIcon" onClick="navToolbar.activate(esri.toolbars.Navigation.PAN);">
                </div>
                <div dojoType="dijit.form.Button" id="deactivate" iconClass="deactivateIcon" onClick="navToolbar.deactivate()">
                </div>
            </div>
            <div dojoType="dijit.Tooltip" connectId="zoomin" position="below">
                Zoom in
            </div>
            <div dojoType="dijit.Tooltip" connectId="zoomout" position="below">
                Zoom out
            </div>
            <div dojoType="dijit.Tooltip" connectId="zoomfullext" position="below">
                Zoom to the full extent
            </div>
            <div dojoType="dijit.Tooltip" connectId="zoomprev" position="below">
                Zoom to the previous extent
            </div>
            <div dojoType="dijit.Tooltip" connectId="zoomnext" position="below">
                Zoom to the next extent
            </div>
            <div dojoType="dijit.Tooltip" connectId="pan" position="below">
                Move the map
            </div>
            <div dojoType="dijit.Tooltip" connectId="deactivate" position="below">
                Deactivate the current tool
            </div>
            <div id="basemapGalleryDiv" dojoType="dijit.layout.ContentPane" id="basemapGalleryDiv" style="width:366px;height:490px;">
                <div id="basemapGallery">
                </div>
                <button dojoType="dijit.form.Button" onclick="hideBasemapGallery()">
                    OK
                </button>
            </div>
        </div>
        <div id="panel" dojotype="dijit.layout.BorderContainer" design="headline" gutters="false">
            <!-- Right Sidebar Section-->
            <div id="rightPane" dojotype="dijit.layout.ContentPane" region="right">
                <div dojotype="dijit.layout.BorderContainer" design="sidebar" gutters="false">
                    <!--Panel Top-->
                    <div id="top" dojotype="dijit.layout.ContentPane" region="top">
                        <div id="taxonHierarchy">
                            <span id="spClass"></span>
                            > <span id="spOrder"></span>
                            > <span id="spFamily"></span>
                            > <span id="spGenus"></span>
                        </div>
                        <div id="species">
                        </div>
                        <div id="spAuthority">
                        </div>
                        <!--     <div id="synonyms">
                        </div>-->
                        <div>
                            <img id="statusImage" src=""/>
                        </div>
                        <div>
                            <img id="speciesImage" src="http://i789.photobucket.com/albums/yy179/brezzy868792/orangutan.jpg" title="Image of Orang Utan"/>
                        </div>
                        <div id="legend">
                            Legend:
                            <div class="legendItem">
                                <div class="legendItemSymbol">
                                </div>
                                <div class="legendItemText">
                                    Native (resident)
                                </div>
                            </div>
                            <button dojoType="dijit.form.Button" onclick="showBasemapGallery()" id="basemapGalleryButton">
                                Click to open basemap gallery
                            </button>
                            <div id="extentMap">
                            </div>
                            <div id="iucnImage">
                                <img src="images/iucn.png" alt="IUCN Image" title="IUCN Redlist Website" onclick="window.open('http://www.iucnredlist.org/')">
                            </div>
                        </div>
                    </div><!--Sidebar Bottom--><!--Panel bottom-->
                    <div id="bottom" dojotype="dijit.layout.ContentPane" region="bottom">
                        <div>
                            T & Cs will be linked here
                        </div>
                        <div>
                            Source will go here
                        </div>
                        Published by IUCN<span id="owner"></span>
                    </div>
                </div>
            </div>
            <!-- Footer Section-->
        </div>
    </body>
</html>
